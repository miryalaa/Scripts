#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"

# Define Variables
$SevenZipVersion = "25.01"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

# Function to get installed 7-Zip version
function Get-7ZipVersion {
    $paths = @(
        "HKLM:\SOFTWARE\7-Zip",
        "HKLM:\SOFTWARE\WOW6432Node\7-Zip"
    )
    foreach ($path in $paths) {
        if (Test-Path $path) {
            try {
                $version = (Get-ItemProperty -Path $path -ErrorAction Stop).Version
                if ($version) { return $version }
            } catch { }
        }
    }
    return $null
}

# Check if 7-Zip is already installed
$currentVersion = Get-7ZipVersion

if ($currentVersion -eq $SevenZipVersion) {
    Write-Host "7-Zip version $SevenZipVersion is already installed. Exiting..."
    exit 0
} elseif ($currentVersion) {
    Write-Host "Detected 7-Zip version $currentVersion, expected $SevenZipVersion. Proceeding with upgrade..."
} else {
    Write-Host "7-Zip not found. Proceeding with fresh installation..."
}

# Ensure the C:\OS directory exists
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Download the installer from Artifactory
Write-Host "Downloading 7-Zip installer from Artifactory..."
Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing

if (Test-Path $InstallerPath) {
    Write-Host "Installer downloaded successfully to $InstallerPath"
} else {
    Write-Host "Error: Failed to download installer."
    exit 1
}

# Install 7-Zip silently
Write-Host "Running 7-Zip silent installation..."
Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

# Verify installation
$installedVersion = Get-7ZipVersion

if ($installedVersion -eq $SevenZipVersion) {
    Write-Host "✅ 7-Zip version $SevenZipVersion installed successfully."
} else {
    Write-Host "⚠️ 7-Zip installation failed or version mismatch. Detected version: $installedVersion"
}

# Cleanup: delete installer and binaries
Write-Host "Cleaning up installation files..."
try {
    Remove-Item -Path $InstallerPath -Force -ErrorAction Stop
    Write-Host "Deleted installer: $InstallerPath"
} catch {
    Write-Host "Warning: Could not delete installer file. $_"
}

Write-Host "Process completed."
exit 0

