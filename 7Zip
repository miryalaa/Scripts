#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"
#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -File "%CD%\__Download\install.ps1"

# Define variables
$SevenZipVersion = "25.01"
$SevenZipName    = "7-Zip"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

# Function to check if 7-Zip is installed
function Test-7ZipInstalled {
    $apps = Get-WmiObject -Class Win32_Product -Filter "Name LIKE '%7-Zip%'" -ErrorAction SilentlyContinue
    if (-not $apps) {
        # If Win32_Product fails (can be slow), fallback to registry query through CIM
        $apps = Get-CimInstance Win32_Product -Filter "Name LIKE '%7-Zip%'" -ErrorAction SilentlyContinue
    }

    foreach ($app in $apps) {
        if ($app.Name -like "*7-Zip*" -and $app.Version -eq $SevenZipVersion) {
            return $true
        }
    }
    return $false
}

# Check if 7-Zip is already installed
Write-Host "Checking if 7-Zip version $SevenZipVersion is installed..."
$installed = Test-7ZipInstalled

if ($installed) {
    Write-Host "✅ 7-Zip version $SevenZipVersion is already installed. Exiting..."
    exit 0
} else {
    Write-Host "7-Zip version $SevenZipVersion not found. Proceeding with installation..."
}

# Ensure the C:\OS directory exists
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Download the installer from Artifactory
Write-Host "Downloading 7-Zip installer from Artifactory..."
Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing

if (Test-Path $InstallerPath) {
    Write-Host "Installer downloaded successfully to $InstallerPath"
} else {
    Write-Host "❌ Error: Failed to download installer."
    exit 1
}

# Install 7-Zip silently
Write-Host "Running 7-Zip silent installation..."
Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

# Re-check installation status
Write-Host "Verifying installation..."
Start-Sleep -Seconds 5
$installed = Test-7ZipInstalled

if ($installed) {
    Write-Host "✅ 7-Zip version $SevenZipVersion installed successfully."
} else {
    Write-Host "❌ Error: 7-Zip installation failed or version mismatch."
}

# Cleanup — delete installer binaries
Write-Host "Cleaning up installer files in $InstallPath ..."
try {
    Get-ChildItem -Path $InstallPath -Filter "*.exe" -File | ForEach-Object {
        Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
        Write-Host "Deleted: $($_.FullName)"
    }
} catch {
    Write-Host "⚠️ Warning: Some files could not be deleted. $_"
}

Write-Host "Process completed."
exit 0
