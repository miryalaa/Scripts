#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"
#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -File "%CD%\__Download\install.ps1"

# Variables
$SevenZipVersion = "25.01"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

Write-Host "=== Checking for existing 7-Zip installation ==="

# Function: Get installed 7-Zip info using Get-Package
function Get-7ZipPackage {
    try {
        $pkg = Get-Package -Name "7-Zip*" -ErrorAction SilentlyContinue |
               Select-Object Name, Version, ProviderName
        return $pkg
    } catch {
        return $null
    }
}

# Step 1: Detect existing version
$installed = Get-7ZipPackage

if ($installed) {
    Write-Host "Detected: $($installed.Name) version $($installed.Version)"
    if ($installed.Version -eq $SevenZipVersion) {
        Write-Host "✅ 7-Zip version $SevenZipVersion is already installed. Exiting..."
        exit 0
    } else {
        Write-Host "⚙️ Older version ($($installed.Version)) found. Uninstalling..."
        try {
            $uninstall = Get-WmiObject -Class Win32_Product -Filter "Name LIKE '7-Zip%'" -ErrorAction SilentlyContinue
            if ($uninstall) {
                $uninstall.Uninstall() | Out-Null
                Write-Host "Uninstallation completed."
            } else {
                Write-Host "⚠️ Unable to find uninstall entry via Win32_Product. Continuing..."
            }
        } catch {
            Write-Host "❌ Uninstallation failed: $_"
        }
    }
} else {
    Write-Host "7-Zip is not currently installed."
}

# Step 2: Prepare install directory
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Step 3: Download installer from Artifactory
Write-Host "Downloading 7-Zip version $SevenZipVersion from Artifactory..."
Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing

if (Test-Path $InstallerPath) {
    Write-Host "✅ Installer downloaded successfully: $InstallerPath"
} else {
    Write-Host "❌ Failed to download installer. Exiting..."
    exit 1
}

# Step 4: Install silently
Write-Host "Installing 7-Zip version $SevenZipVersion..."
Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

# Step 5: Verify installation
Write-Host "Verifying 7-Zip installation..."
Start-Sleep -Seconds 5
$newInstall = Get-7ZipPackage

if ($newInstall -and $newInstall.Version -eq $SevenZipVersion) {
    Write-Host "✅ 7-Zip version $SevenZipVersion installed successfully."
} else {
    Write-Host "❌ Installation verification failed. Version mismatch or not found."
}

# Step 6: Cleanup
Write-Host "Cleaning up installer files..."
try {
    Get-ChildItem -Path $InstallPath -Filter "*.exe" -File | Remove-Item -Force -ErrorAction SilentlyContinue
    Write-Host "✅ Cleanup complete."
} catch {
    Write-Host "⚠️ Warning: Some files could not be deleted. $_"
}

Write-Host "=== Process completed ==="
exit 0


Write-Host "Process completed."
exit 0
