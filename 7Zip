#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"
#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -File "%CD%\__Download\install.ps1"

# Define variables
$SevenZipVersion = "25.01"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

# Function: Check if 7-Zip version is installed via registry uninstall entries
function Test-7ZipInstalled {
    $paths = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    foreach ($path in $paths) {
        $apps = Get-ItemProperty $path -ErrorAction SilentlyContinue |
            Where-Object { $_.DisplayName -like "7-Zip*" } |
            Select-Object DisplayName, DisplayVersion

        foreach ($app in $apps) {
            if ($app.DisplayVersion -eq $SevenZipVersion) {
                return $true
            }
        }
    }
    return $false
}

# Step 1: Check if 7-Zip is already installed
Write-Host "Checking if 7-Zip version $SevenZipVersion is installed..."
$installed = Test-7ZipInstalled

if ($installed) {
    Write-Host "✅ 7-Zip version $SevenZipVersion is already installed. Exiting..."
    exit 0
} else {
    Write-Host "7-Zip version $SevenZipVersion not found. Proceeding with installation..."
}

# Step 2: Ensure the C:\OS directory exists
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Step 3: Download the installer from Artifactory
Write-Host "Downloading 7-Zip installer from Artifactory..."
Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing

if (Test-Path $InstallerPath) {
    Write-Host "✅ Installer downloaded successfully to $InstallerPath"
} else {
    Write-Host "❌ Error: Failed to download installer."
    exit 1
}

# Step 4: Run the installer silently
Write-Host "Running 7-Zip silent installation..."
Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

# Step 5: Verify installation
Write-Host "Verifying installation..."
Start-Sleep -Seconds 5
$installed = Test-7ZipInstalled

if ($installed) {
    Write-Host "✅ 7-Zip version $SevenZipVersion installed successfully."
} else {
    Write-Host "❌ Error: 7-Zip installation failed or version mismatch."
}

# Step 6: Cleanup — delete installer binaries
Write-Host "Cleaning up installer files in $InstallPath ..."
try {
    Get-ChildItem -Path $InstallPath -Filter "*.exe" -File | ForEach-Object {
        Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
        Write-Host "Deleted: $($_.FullName)"
    }
} catch {
    Write-Host "⚠️ Warning: Some files could not be deleted. $_"
}

Write-Host "Process completed."
exit 0
