#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"
#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -File "%CD%\__Download\install.ps1"

# Variables
$SevenZipVersion = "25.01"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

Write-Host "=== Starting 7-Zip installation process ==="

# Function: Get installed 7-Zip package info
function Get-7ZipPackage {
    try {
        Get-Package -Name "7-Zip*" -ErrorAction SilentlyContinue |
        Select-Object Name, Version, ProviderName
    } catch {
        return $null
    }
}

# Step 1: Detect existing installation
Write-Host "Checking for installed 7-Zip versions..."
$installed = Get-7ZipPackage

if ($installed) {
    Write-Host "Detected: $($installed.Name) version $($installed.Version)"
    if ($installed.Version -eq $SevenZipVersion) {
        Write-Host "✅ 7-Zip version $SevenZipVersion already installed. Exiting."
        exit 0
    } else {
        Write-Host "⚙️ Uninstalling older 7-Zip version $($installed.Version)..."
        try {
            # Attempt uninstall via Win32_Product
            $uninstall = Get-WmiObject -Class Win32_Product -Filter "Name LIKE '7-Zip%'" -ErrorAction SilentlyContinue
            if ($uninstall) {
                $uninstall.Uninstall() | Out-Null
                Write-Host "✅ Uninstallation completed."
            } else {
                Write-Host "⚠️ No MSI uninstall entry found. Attempting registry-based uninstall..."
                $uninstallKeys = @(
                    "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
                    "HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
                )
                foreach ($key in $uninstallKeys) {
                    $app = Get-ItemProperty $key -ErrorAction SilentlyContinue |
                        Where-Object { $_.DisplayName -like "7-Zip*" }
                    if ($app.UninstallString) {
                        Write-Host "Running: $($app.UninstallString)"
                        Start-Process -FilePath "cmd.exe" -ArgumentList "/c $($app.UninstallString) /S" -Wait
                    }
                }
            }
        } catch {
            Write-Host "❌ Uninstallation failed: $_"
        }
    }
} else {
    Write-Host "7-Zip not detected on this system."
}

# Step 2: Prepare installation directory
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Step 3: Download the new installer
Write-Host "Downloading 7-Zip $SevenZipVersion installer from Artifactory..."
try {
    Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing
    Write-Host "✅ Downloaded to $InstallerPath"
} catch {
    Write-Host "❌ Failed to download installer from Artifactory. Exiting."
    exit 1
}

# Step 4: Install silently
Write-Host "Installing 7-Zip version $SevenZipVersion..."
try {
    Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait
    Write-Host "✅ Installation completed."
} catch {
    Write-Host "❌ Installation failed: $_"
    exit 1
}

# Step 5: Verify installation
Write-Host "Verifying installation..."
Start-Sleep -Seconds 5
$newInstall = Get-7ZipPackage
if ($newInstall -and $newInstall.Version -eq $SevenZipVersion) {
    Write-Host "✅ Verified: 7-Zip version $SevenZipVersion installed successfully."
} else {
    Write-Host "❌ Verification failed. Installed version: $($newInstall.Version)"
}

# Step 6: Cleanup
Write-Host "Cleaning up installer files..."
try {
    Remove-Item -Path $InstallerPath -Force -ErrorAction SilentlyContinue
    Write-Host "✅ Installer deleted."
} catch {
    Write-Host "⚠️ Could not delete installer file: $_"
}

Write-Host "=== 7-Zip deployment completed successfully ==="
exit 0
