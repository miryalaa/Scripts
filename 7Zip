#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& { Start-Process PowerShell -ArgumentList '-ExecutionPolicy Bypass -NoProfile -File ""%CD%\__Download\install.ps1""' -Verb RunAs }"
#cmd.exe /c powershell.exe -ExecutionPolicy Bypass -NoProfile -File "%CD%\__Download\install.ps1"

# Define variables
$SevenZipVersion = "25.01"
$ArtifactoryURL  = "https://your-artifactory.company.com/path/to/7z2501-x64.exe"
$InstallPath     = "C:\OS"
$InstallerName   = "7z2501-x64.exe"
$InstallerPath   = Join-Path $InstallPath $InstallerName

# Function: Get installed 7-Zip details (DisplayName, DisplayVersion, UninstallString)
function Get-7ZipInstallInfo {
    $paths = @(
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    foreach ($path in $paths) {
        $apps = Get-ItemProperty $path -ErrorAction SilentlyContinue |
            Where-Object { $_.DisplayName -like "7-Zip*" } |
            Select-Object DisplayName, DisplayVersion, UninstallString

        if ($apps) { return $apps }
    }
    return $null
}

# Step 1: Check if 7-Zip is installed
Write-Host "Checking if 7-Zip is installed..."
$installedApps = Get-7ZipInstallInfo

if ($installedApps) {
    foreach ($app in $installedApps) {
        Write-Host "Detected: $($app.DisplayName) version $($app.DisplayVersion)"
        if ($app.DisplayVersion -eq $SevenZipVersion) {
            Write-Host "✅ 7-Zip version $SevenZipVersion is already installed. Exiting..."
            exit 0
        } else {
            Write-Host "⚙️ Older version ($($app.DisplayVersion)) detected. Uninstalling before upgrade..."
            if ($app.UninstallString) {
                try {
                    # Some uninstall strings include "msiexec /I"; replace with /x for silent uninstall
                    $uninstallCmd = $app.UninstallString.Replace("/I", "/x") + " /quiet /norestart"
                    Write-Host "Running: $uninstallCmd"
                    Start-Process -FilePath "cmd.exe" -ArgumentList "/c $uninstallCmd" -Wait
                    Write-Host "Uninstallation completed."
                } catch {
                    Write-Host "❌ Failed to uninstall existing 7-Zip. $_"
                }
            } else {
                Write-Host "⚠️ No uninstall command found for older 7-Zip version."
            }
        }
    }
} else {
    Write-Host "No previous 7-Zip installation found."
}

# Step 2: Ensure C:\OS exists
if (-not (Test-Path $InstallPath)) {
    New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
}

# Step 3: Download installer from Artifactory
Write-Host "Downloading 7-Zip version $SevenZipVersion installer from Artifactory..."
Invoke-WebRequest -Uri $ArtifactoryURL -OutFile $InstallerPath -UseBasicParsing

if (Test-Path $InstallerPath) {
    Write-Host "✅ Installer downloaded successfully to $InstallerPath"
} else {
    Write-Host "❌ Error: Failed to download installer."
    exit 1
}

# Step 4: Install new 7-Zip version silently
Write-Host "Installing 7-Zip version $SevenZipVersion..."
Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait

# Step 5: Verify installation
Write-Host "Verifying installation..."
Start-Sleep -Seconds 5
$newInstall = Get-7ZipInstallInfo
$found = $false

if ($newInstall) {
    foreach ($app in $newInstall) {
        if ($app.DisplayVersion -eq $SevenZipVersion) {
            Write-Host "✅ 7-Zip version $SevenZipVersion installed successfully."
            $found = $true
        }
    }
}

if (-not $found) {
    Write-Host "❌ Error: 7-Zip installation failed or version mismatch."
}

# Step 6: Cleanup
Write-Host "Cleaning up installer files in $InstallPath..."
try {
    Get-ChildItem -Path $InstallPath -Filter "*.exe" -File | ForEach-Object {
        Remove-Item $_.FullName -Force -ErrorAction SilentlyContinue
        Write-Host "Deleted: $($_.FullName)"
    }
} catch {
    Write-Host "⚠️ Warning: Some files could not be deleted. $_"
}

Write-Host "Process completed."
exit 0
